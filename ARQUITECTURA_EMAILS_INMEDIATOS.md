# ๐ Arquitectura de Emails Inmediatos

## ๐ Flujo Completo

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         USUARIO PAGA SUSCRIPCIรN                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                   โ
                                   โผ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ   MercadoPago Webhook    โ
                    โ  /api/mercadopago/       โ
                    โ       webhook            โ
                    โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
                                 โ
                                 โผ
                    โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ  UPDATE unified_         โ
                    โ  subscriptions           โ
                    โ  SET status = 'active'   โ
                    โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
                                 โ
                                 โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  TRIGGER: trigger_send_immediate_notification  โ
        โ  (AFTER UPDATE ON unified_subscriptions)       โ
        โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ  FUNCTION: log_and_send_subscription_          โ
        โ  notification()                                โ
        โ                                                โ
        โ  1. Verifica: OLD.status != NEW.status         โ
        โ  2. Extrae email de customer_data              โ
        โ  3. INSERT INTO subscription_notifications     โ
        โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
             โโโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโโ
             โ                               โ
             โผ                               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  WEBHOOK DE SUPABASE   โ      โ   CRON JOB (Respaldo)  โ
โ  (< 1 segundo)         โ      โ   (cada 5 minutos)     โ
โ                        โ      โ                        โ
โ  Detecta INSERT en     โ      โ  Procesa notificacionesโ
โ  subscription_         โ      โ  pendientes si el      โ
โ  notifications         โ      โ  webhook fallรณ         โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโ      โโโโโโโโโโโโโโฌโโโโโโโโโโโโ
            โ                                โ
            โ                                โ
            โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ  POST /api/admin/        โ
            โ  subscription-           โ
            โ  notifications           โ
            โ                          โ
            โ  { notification_id: X }  โ
            โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
                         โ
                         โผ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ  processNotification()   โ
            โ                          โ
            โ  1. Obtiene datos        โ
            โ  2. Selecciona template  โ
            โ  3. Envรญa email          โ
            โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโ
                         โ
             โโโโโโโโโโโโโดโโโโโโโโโโโโ
             โ                       โ
             โผ                       โผ
โโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโ
โ  EMAIL USUARIO     โ   โ  UPDATE            โ
โ  โ Enviado        โ   โ  notification_     โ
โ                    โ   โ  sent = true       โ
โโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Comparaciรณn: ANTES vs. AHORA

### โฐ ANTES (con delay de 5 minutos)

```
Pago aprobado (12:00:00)
    โ
Trigger crea notificaciรณn (12:00:01)
    โ
[ESPERA...]
    โ
Cron job se ejecuta (12:05:00)
    โ
Email enviado (12:05:02)
    โ
โ๏ธ Usuario recibe email 5 MINUTOS despuรฉs
```

**Tiempo total: ~5 minutos** โ

---

### โก AHORA (inmediato)

```
Pago aprobado (12:00:00.000)
    โ
Trigger crea notificaciรณn (12:00:00.100)
    โ
Webhook detecta INSERT (12:00:00.200)
    โ
API procesa notificaciรณn (12:00:00.500)
    โ
Email enviado (12:00:01.000)
    โ
โ๏ธ Usuario recibe email en < 1 SEGUNDO
```

**Tiempo total: < 1 segundo** โ

---

## ๐ง Componentes del Sistema

### 1. Base de Datos (Supabase PostgreSQL)

#### Tabla: `unified_subscriptions`
```sql
CREATE TABLE unified_subscriptions (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL,
  status VARCHAR(50), -- 'pending', 'active', 'paused', 'cancelled'
  customer_data JSONB,
  -- ... otros campos
);
```

#### Tabla: `subscription_notifications`
```sql
CREATE TABLE subscription_notifications (
  id BIGSERIAL PRIMARY KEY,
  subscription_id BIGINT REFERENCES unified_subscriptions(id),
  old_status VARCHAR(50),
  new_status VARCHAR(50),
  user_email VARCHAR(255),
  notification_sent BOOLEAN DEFAULT false,
  email_sent_at TIMESTAMPTZ,
  error_message TEXT,
  retry_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### Trigger: `trigger_send_immediate_notification`
```sql
CREATE TRIGGER trigger_send_immediate_notification
  AFTER UPDATE ON unified_subscriptions
  FOR EACH ROW
  EXECUTE FUNCTION log_and_send_subscription_notification();
```

---

### 2. Webhook de Supabase

**Configuraciรณn:**
```json
{
  "name": "send-subscription-email",
  "table": "subscription_notifications",
  "events": ["INSERT"],
  "type": "HTTP",
  "method": "POST",
  "url": "https://petgourmet.mx/api/admin/subscription-notifications",
  "headers": {
    "Content-Type": "application/json"
  },
  "body": {
    "notification_id": "{{ record.id }}",
    "subscription_id": "{{ record.subscription_id }}",
    "immediate": true
  },
  "timeout": 10000,
  "retries": 3
}
```

**Caracterรญsticas:**
- โก Latencia: < 200ms
- ๐ Reintentos automรกticos: 3x
- ๐ Logs integrados
- ๐ฏ Solo se activa en INSERT

---

### 3. API Endpoint: `/api/admin/subscription-notifications`

**Antes (solo cron):**
```typescript
export async function POST(request: NextRequest) {
  // Procesar TODAS las notificaciones pendientes
  const { data: notifications } = await supabase
    .from('subscription_notifications')
    .select('*')
    .eq('notification_sent', false)
    .limit(20);
  
  // Procesar en batch
  for (const notification of notifications) {
    await processNotification(notification);
  }
}
```

**Ahora (soporta ambos):**
```typescript
export async function POST(request: NextRequest) {
  const body = await request.json();
  
  // Si viene notification_id โ PROCESAR UNA SOLA (inmediato)
  if (body.notification_id) {
    const { data: notification } = await supabase
      .from('subscription_notifications')
      .select('*')
      .eq('id', body.notification_id)
      .single();
    
    return await processNotification(notification);
  }
  
  // Si no viene notification_id โ PROCESAR TODAS (cron)
  const { data: notifications } = await supabase
    .from('subscription_notifications')
    .select('*')
    .eq('notification_sent', false)
    .limit(20);
  
  // Procesar en batch
  for (const notification of notifications) {
    await processNotification(notification);
  }
}
```

---

### 4. Email Service: `lib/email-service.ts`

**Templates por estado:**
```typescript
const templates = {
  'active': {
    subject: '๐ ยกTu suscripciรณn estรก activa!',
    template: 'subscription-active.html'
  },
  'paused': {
    subject: 'โธ๏ธ Tu suscripciรณn ha sido pausada',
    template: 'subscription-paused.html'
  },
  'cancelled': {
    subject: 'โ Tu suscripciรณn ha sido cancelada',
    template: 'subscription-cancelled.html'
  },
  // ... mรกs templates
};
```

---

## ๐ก๏ธ Sistema de Respaldo

### Doble Garantรญa de Envรญo

#### 1. Webhook (Principal - < 1 segundo)
```
INSERT notification โ Webhook โ Email enviado โ
```

#### 2. Cron Job (Respaldo - cada 5 minutos)
```
Webhook fallรณ โ notification_sent = false โ Cron detecta โ Reenvรญa โ
```

### Gestiรณn de Errores

```typescript
// En processNotification()
try {
  await emailService.sendEmail(notification);
  
  // โ รxito
  await supabase
    .from('subscription_notifications')
    .update({
      notification_sent: true,
      email_sent_at: new Date().toISOString(),
      error_message: null
    })
    .eq('id', notification.id);
    
} catch (error) {
  // โ Error
  await supabase
    .from('subscription_notifications')
    .update({
      retry_count: notification.retry_count + 1,
      error_message: error.message
    })
    .eq('id', notification.id);
  
  // Si retry_count < 5, el cron lo reintentarรก
}
```

---

## ๐ Mรฉtricas de Performance

### Latencias Esperadas

| Componente | Tiempo |
|------------|--------|
| UPDATE subscription | 50ms |
| Trigger ejecuta funciรณn | 20ms |
| INSERT notification | 30ms |
| Webhook detecta INSERT | 100ms |
| API procesa notificaciรณn | 200ms |
| EmailService envรญa email | 500ms |
| **TOTAL** | **< 1 segundo** โ |

### Tasa de รxito

```sql
-- Query para verificar tasa de รฉxito
SELECT 
  notification_sent,
  COUNT(*) as cantidad,
  ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM subscription_notifications), 2) as porcentaje
FROM subscription_notifications
GROUP BY notification_sent;
```

**Resultado esperado:**
```
notification_sent | cantidad | porcentaje
------------------|----------|------------
true              | 95       | 99.0%
false             | 1        | 1.0%
```

---

## ๐ Debugging y Monitoreo

### 1. Ver รบltimas notificaciones
```sql
SELECT 
  id,
  subscription_id,
  old_status || ' โ ' || new_status as cambio,
  notification_sent,
  EXTRACT(EPOCH FROM (email_sent_at - created_at)) as segundos_delay,
  created_at
FROM subscription_notifications
ORDER BY created_at DESC
LIMIT 10;
```

### 2. Ver webhooks ejecutados (Supabase Dashboard)
```
Database โ Webhooks โ send-subscription-email โ View Logs
```

Deberรญas ver:
```
โ 200 OK - Email enviado (1.2s)
โ 200 OK - Email enviado (0.9s)
โ 200 OK - Email enviado (1.1s)
```

### 3. Ver logs de Vercel
```
Vercel Dashboard โ Logs โ Filtrar: "/api/admin/subscription-notifications"
```

---

## โ Ventajas de Esta Arquitectura

1. **โก Inmediato:** Email en < 1 segundo
2. **๐ก๏ธ Confiable:** Webhook + Cron = doble garantรญa
3. **๐ Observable:** Logs en Supabase y Vercel
4. **๐ Auto-retry:** 3 intentos automรกticos del webhook
5. **๐ฐ Econรณmico:** Sin costos adicionales (plan Pro)
6. **๐งฉ Desacoplado:** Cambios en email no afectan trigger
7. **๐ Seguro:** Validaciรณn en API, no puede ser llamado externamente
8. **๐ Escalable:** Soporta miles de notificaciones simultรกneas

---

## ๐ซ Problemas Comunes y Soluciones

### Problema 1: Webhook no se ejecuta
**Sรญntoma:** Notificaciรณn creada pero `notification_sent = false` despuรฉs de 1 minuto

**Diagnรณstico:**
```sql
SELECT * FROM subscription_notifications 
WHERE notification_sent = false 
AND created_at > NOW() - INTERVAL '5 minutes';
```

**Soluciรณn:**
1. Verificar webhook en Supabase Dashboard โ Database โ Webhooks
2. Ver logs del webhook: ยฟhay errores?
3. Verificar URL del webhook: `https://petgourmet.mx/api/admin/subscription-notifications`
4. Verificar que el endpoint estรก desplegado en Vercel

---

### Problema 2: Webhook devuelve 500 Internal Server Error
**Sรญntoma:** Logs del webhook muestran `500 Internal Server Error`

**Diagnรณstico:**
Ver logs de Vercel:
```
Vercel โ Project โ Logs โ Filter: "subscription-notifications"
```

**Soluciรณn:**
1. Verificar que `notification_id` existe en la base de datos
2. Verificar configuraciรณn de Nodemailer (SMTP)
3. Ver error especรญfico en logs de Vercel
4. El cron job lo reintentarรก en 5 minutos

---

### Problema 3: Email no llega a usuario
**Sรญntoma:** `notification_sent = true` pero usuario no recibe email

**Diagnรณstico:**
```sql
SELECT 
  user_email,
  email_sent_at,
  error_message
FROM subscription_notifications
WHERE id = [NOTIFICATION_ID];
```

**Soluciรณn:**
1. Verificar carpeta de SPAM
2. Verificar que `user_email` es correcto
3. Verificar logs de Nodemailer
4. Verificar configuraciรณn SMTP en variables de entorno

---

## ๐ฏ Checklist Final

- [ ] SQL ejecutado: `EJECUTAR-AHORA-emails-inmediatos.sql`
- [ ] Webhook configurado en Supabase Dashboard
- [ ] Cรณdigo deployado en Vercel
- [ ] Prueba realizada: cambio de estado de suscripciรณn
- [ ] Email recibido en < 5 segundos
- [ ] Logs del webhook: `200 OK`
- [ ] `notification_sent = true` en la base de datos

**ยกSistema de emails inmediatos funcionando! ๐**
